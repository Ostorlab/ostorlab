"""Unit tests for Report Vulnerability Mixin."""

from typing import List

from ostorlab.agent import agent
from ostorlab.agent import definitions as agent_definitions
from ostorlab.agent.kb import kb as knowledge_base
from ostorlab.agent.mixins import agent_report_vulnerability_mixin
from ostorlab.runtimes import definitions as runtime_definitions


class TestAgent(agent.Agent, agent_report_vulnerability_mixin.AgentReportVulnMixin):
    pass


def testSendVulnerabilityMessage_whenKbEntryIsValid_emitVulnerabilityMessage(agent_mock: List[object]) -> None:
    """Prepares & emit vulnerability message with all the information from the Knowledge base."""
    agent_definition = agent_definitions.AgentDefinition(name='some_name', out_selectors=['v3.report.vulnerability'])
    agent_settings = runtime_definitions.AgentSettings(key='some_key')
    report_vul_mixin = TestAgent(agent_definition, agent_settings)
    report_vul_mixin.report_vulnerability(
        entry=knowledge_base.KB.VIRUSTOTAL_SCAN,
        technical_detail='some_technical_detail',
        risk_rating=agent_report_vulnerability_mixin.RiskRating.HIGH,
        dna='some_dna')

    assert len(agent_mock) == 1
    assert agent_mock[0].selector == 'v3.report.vulnerability'
    assert agent_mock[0].data['short_description'] == 'VirusTotal Malware analysis'
    assert agent_mock[0].data['privacy_issue']
    assert agent_mock[0].data['security_issue']
    assert agent_mock[0].data['risk_rating'] == 'HIGH'
    assert agent_mock[0].data['references'] == [{'title': 'Virustotal', 'url': 'https://www.virustotal.com/'}]
